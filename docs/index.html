<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DemiPay v5.8 (‚Ç¶ Edition) ‚Äî Money Moves</title>

<!-- ===== Base Styles (scoped for demo) ===== -->
<style>
  :root{
    --bg:#f7f9fc;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --brand:#2dd4bf;
    --brand2:#3b82f6;
    --danger:#ef4444;
    --success:#22c55e;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --radius:16px;
    --ring:0 0 0 3px rgba(59,130,246,.25);
  }
  body.dark{
    --bg:#0b1220;
    --card:#0f172a;
    --text:#e2e8f0;
    --muted:#94a3b8;
    --shadow:0 8px 24px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  a{color:inherit;text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:24px}

  /* ===== Navbar ===== */
  .navbar{
    position:sticky;top:0;z-index:1000;background:var(--card);
    border-bottom:1px solid rgba(148,163,184,.15);
    backdrop-filter: blur(6px);
    box-shadow: 0 2px 12px rgba(0,0,0,.05);
  }
  .nav-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  .brand .logo{font-size:20px}
  .badge{font-size:12px;border:1px solid rgba(148,163,184,.35);padding:2px 8px;border-radius:999px}
  .menu{display:flex;align-items:center;gap:10px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(148,163,184,.35);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{box-shadow:var(--shadow)}
  .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border:none;color:#fff}
  .user-menu{position:relative}
  .user-btn{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;border:1px solid rgba(148,163,184,.35);background:var(--card);cursor:pointer}
  .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid rgba(148,163,184,.35)}
  .dropdown{position:absolute;right:0;top:44px;background:var(--card);border:1px solid rgba(148,163,184,.25);border-radius:12px;box-shadow:var(--shadow);display:none;min-width:200px;overflow:hidden}
  .dropdown.show{display:block;animation:fadeIn .15s ease}
  .dropdown a,.dropdown button{display:flex;width:100%;gap:8px;align-items:center;padding:10px 12px;background:none;border:none;color:var(--text);cursor:pointer}
  .dropdown a:hover,.dropdown button:hover{background:rgba(148,163,184,.12)}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

  /* ===== Header / Balance ===== */
  .welcome h1{margin:0 0 6px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:16px}
  .card{background:var(--card);border:1px solid rgba(148,163,184,.15);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .balance-row{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
  .balance-amount{font-size:32px;font-weight:800;letter-spacing:.3px}
  .wallet-meta{font-size:14px;color:var(--muted);margin-top:6px}

  /* ===== Banners ===== */
  .banner{display:flex;gap:12px;align-items:center;border-left:6px solid var(--brand2)}
  .banner .emoji{font-size:20px}

  /* ===== Money Moves & Services ===== */
  .section-title{margin:0 0 8px}
  .actions,.services{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .action,.service{background:var(--card);border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:16px;cursor:pointer;transition:.2s;display:flex;flex-direction:column;gap:4px}
  .action:hover,.service:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
  .action .icon,.service .icon{font-size:22px}
  .action .title,.service .title{font-weight:700}
  .action .desc,.service .desc{font-size:13px;color:var(--muted)}
  .hover-pulse:hover{box-shadow:0 0 0 4px rgba(59,130,246,.15)}

  /* ===== Transactions ===== */
  .tx-list{display:flex;flex-direction:column;gap:10px}
  .tx{display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:12px;background:var(--card)}
  .tx-left{display:flex;gap:10px;align-items:center}
  .tx-ic{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;font-size:18px;background:rgba(148,163,184,.12)}
  .tx-right{text-align:right}
  .positive{color:var(--success);font-weight:700}
  .negative{color:var(--danger);font-weight:700}
  .status{font-size:12px;color:var(--muted)}

  /* ===== Modals ===== */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:2000}
  .overlay.show{display:flex;animation:fadeIn .15s ease}
  .modal{width:min(560px,92vw);background:var(--card);border:1px solid rgba(148,163,184,.25);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(148,163,184,.2)}
  .modal-body{padding:16px}
  .modal-footer{padding:14px 16px;border-top:1px solid rgba(148,163,184,.2);display:flex;justify-content:flex-end;gap:10px}
  .close-x{background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea{padding:10px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.35);background:var(--card);color:var(--text)}
  input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
  textarea{min-height:84px;resize:vertical}

  /* Toasts */
  .toast{position:fixed;top:16px;right:16px;padding:12px 16px;border-radius:12px;color:#fff;z-index:3000;box-shadow:var(--shadow);opacity:0;transform:translateY(-12px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast-success{background:linear-gradient(90deg,#22c55e,#16a34a)}
  .toast-error{background:linear-gradient(90deg,#ef4444,#dc2626)}
  .toast-warning{background:linear-gradient(90deg,#f59e0b,#d97706)}
  .toast-bottom{position:fixed;bottom:16px;left:16px}

  /* Scroll-to-top */
  #scrollTop{position:fixed;bottom:20px;right:20px;width:44px;height:44px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:1200}
  #scrollTop.show{display:flex}

  /* Small screens */
  @media (max-width:900px){
    .actions,.services{grid-template-columns:repeat(2,1fr)}
    .row{grid-template-columns:1fr}
    .balance-row{flex-direction:column}
  }
</style>
</head>

<body>
  <!-- ===== NAVBAR ===== -->
  <nav class="navbar">
    <div class="nav-inner">
      <div class="brand" onclick="location.href='index.html'" style="cursor:pointer">
        <div class="logo">üöÄ</div>
        <div>DemiPay</div>
        <div class="badge">v5.8 (‚Ç¶)</div>
      </div>

      <div class="menu">
        <button class="btn" id="themeToggle"><span id="themeIcon">üåô</span><span id="themeText">Dark Mode</span></button>

        <div class="user-menu">
          <button class="user-btn" id="userMenuBtn">
            <img class="avatar" id="userAvatar" alt="User" src="https://i.pravatar.cc/64?img=12" />
            <span id="userName">Demi</span> ‚ñæ
          </button>
          <div class="dropdown" id="userDropdown">
            <button id="openProfile">üë§ Profile</button>
            <button id="openSettings">‚öôÔ∏è Settings</button>
            <div style="height:1px;background:rgba(148,163,184,.2);margin:4px 0"></div>
            <button id="logoutBtn">üö™ Logout</button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- ===== PAGE ===== -->
  <main class="container">
    <!-- Welcome -->
    <section class="card welcome">
      <h1>Welcome back, Demi üëã</h1>
      <div class="muted">Here‚Äôs what‚Äôs happening with your wallet today.</div>
    </section>

    <!-- Balance -->
    <section class="card">
      <div class="balance-row">
        <div>
          <div class="muted">Total Balance</div>
          <div class="balance-amount" id="balanceAmount">‚Ç¶0.00</div>
          <div class="wallet-meta" id="walletAddress">Wallet: Loading‚Ä¶</div>
          <div class="wallet-meta">Account No: <b>DP-1029345678</b> ‚Ä¢ KYC: <b>Tier 2 (Verified)</b></div>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn" id="refreshBalance"><span>üîÑ</span>Refresh</button>
          <button class="btn btn-primary" id="addMoneyQuick">‚ûï Add Money</button>
        </div>
      </div>
    </section>

    <!-- Banners -->
    <section class="grid">
      <div class="card banner">
        <div class="emoji">üîí</div>
        <div>
          <div class="title" style="font-weight:700">Security</div>
          <div class="muted">Your wallet is protected with encryption and OTP verification.</div>
        </div>
      </div>
      <div class="card banner" style="border-left-color:var(--brand)">
        <div class="emoji">üíπ</div>
        <div>
          <div class="title" style="font-weight:700">Finance Updates</div>
          <div class="muted">FX: ‚Ç¶1 ‚âà $0.0012 ‚Ä¢ Earn +5% APY bonus this week!</div>
        </div>
      </div>
    </section>

    <!-- Money Moves -->
    <section class="card">
      <h3 class="section-title">Money Moves</h3>
      <div class="actions">
        <div class="action hover-pulse" id="sendMoney">
          <div class="icon">üí∏</div>
          <div class="title">Send Money</div>
          <div class="desc">Instant P2P transfer</div>
        </div>
        <div class="action hover-pulse" id="receiveMoney">
          <div class="icon">üì•</div>
          <div class="title">Receive Money</div>
          <div class="desc">QR & account share</div>
        </div>
        <div class="action hover-pulse" id="addWithdraw">
          <div class="icon">‚ûï</div>
          <div class="title">Add / Withdraw</div>
          <div class="desc">Card or bank (mock)</div>
        </div>
        <div class="action hover-pulse" id="bankTransfer">
          <div class="icon">üè¶</div>
          <div class="title">Bank Transfer</div>
          <div class="desc">Multi-region banks</div>
        </div>
      </div>
    </section>

    <!-- Services -->
    <section class="card">
      <h3 class="section-title">Services</h3>
      <div class="services">
        <div class="service" data-service="fx">
          <div class="icon">üåç</div>
          <div class="title">Cross-Border Remittance</div>
          <div class="desc">Preview FX & send abroad</div>
        </div>
        <div class="service" data-service="savings">
          <div class="icon">üí∞</div>
          <div class="title">Savings</div>
          <div class="desc">Goals ‚Ä¢ SO ‚Ä¢ Chart</div>
        </div>
        <div class="service" data-service="bills">
          <div class="icon">üí°</div>
          <div class="title">Pay Bills & Top-Up</div>
          <div class="desc">Utilities ‚Ä¢ Airtime</div>
        </div>
        <div class="service" data-service="cards">
          <div class="icon">üí≥</div>
          <div class="title">Virtual & Linked Cards</div>
          <div class="desc">Add ‚Ä¢ Link ‚Ä¢ Default</div>
        </div>
        <div class="service" data-service="payonline">
          <div class="icon">üõí</div>
          <div class="title">Pay Online</div>
          <div class="desc">Checkout (‚Ç¶ / $)</div>
        </div>
        <div class="service" data-service="shop">
          <div class="icon">üè¨</div>
          <div class="title">Shop on the Fly</div>
          <div class="desc">Affiliates & deals</div>
        </div>
        <div class="service" data-service="invest">
          <div class="icon">üìà</div>
          <div class="title">Investments & Stocks</div>
          <div class="desc">$ prices ‚Ä¢ buy</div>
        </div>
        <div class="service" data-service="agent">
          <div class="icon">üßç‚Äç‚ôÇÔ∏è</div>
          <div class="title">Become an Agent</div>
          <div class="desc">Photo + NIN + Biz</div>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 class="section-title">Recent Transactions</h3>
        <button class="btn" id="viewAllTx">View All</button>
      </div>
      <div class="tx-list" id="txList"></div>
    </section>
  </main>

  <!-- Scroll to top -->
  <button id="scrollTop" title="Back to top">‚¨ÜÔ∏è</button>

  <!-- ========= Modals (reused overlay) ========= -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div id="modalTitle" style="font-weight:800">Title</div>
        <button class="close-x" id="modalClose">‚úï</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- dynamic content -->
      </div>
      <div class="modal-footer" id="modalFooter">
        <!-- dynamic buttons -->
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastTop" class="toast"></div>
  <div id="toastBottom" class="toast toast-bottom"></div>

<script>
/* ==========================
   Utilities / Mock Data
========================== */
const state = {
  user: { id:'u_1', name:'Demi', avatar:'https://i.pravatar.cc/64?img=12', wallet:'DPX-7FA1-AB12' },
  balance: 125000, // NGN
  tx: [
    { id:'t1', kind:'Received', name:'Upwork Ltd', desc:'Freelance Payment', amount:+52000, status:'completed', ts:Date.now()-3600e3 },
    { id:'t2', kind:'Sent', name:'Bolt', desc:'Ride Payment', amount:-1800, status:'completed', ts:Date.now()-2*3600e3 },
    { id:'t3', kind:'Sent', name:'Netflix', desc:'Monthly Subscription', amount:-6500, status:'pending', ts:Date.now()-26*3600e3 },
    { id:'t4', kind:'Received', name:'Jane Smith', desc:'Refund', amount:+12000, status:'completed', ts:Date.now()-3*24*3600e3 },
    { id:'t5', kind:'Sent', name:'Airtime', desc:'Top-up MTN', amount:-1500, status:'completed', ts:Date.now()-6*24*3600e3 },
  ],
  fxRate: 1500, // ‚Ç¶ per $ (mock)
  defaultCard: 'virtual',
  cards: [
    { id:'virtual', brand:'DemiPay VISA', last4:'8844', type:'virtual', bank:'DemiPay', contactless:true },
    { id:'gtb', brand:'GTBank', last4:'1022', type:'linked', bank:'GTBank', contactless:true },
    { id:'uba', brand:'UBA', last4:'5590', type:'linked', bank:'UBA', contactless:true },
    { id:'zen', brand:'Zenith', last4:'3311', type:'linked', bank:'Zenith', contactless:true },
  ],
  savings: [
    { id:'sv1', name:'Emergency', amount:60000, color:'#3b82f6' },
    { id:'sv2', name:'Rent', amount:100000, color:'#22c55e' },
    { id:'sv3', name:'Holiday', amount:30000, color:'#f59e0b' },
  ],
  cart: []
};

const qs = (sel, root=document)=>root.querySelector(sel);
const qsa = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
const fmtNGN = v => '‚Ç¶'+(Number(v||0)).toLocaleString('en-NG', {maximumFractionDigits:2});
const fmtUSD = v => '$'+(Number(v||0)).toLocaleString('en-US', {maximumFractionDigits:2});
const ago = t => {
  const d = Math.floor((Date.now()-t)/1e3);
  if(d<60) return d+'s ago';
  const m=Math.floor(d/60); if(m<60) return m+'m ago';
  const h=Math.floor(m/60); if(h<24) return h+'h ago';
  const day=Math.floor(h/24); return day+'d ago';
};
function showToast(type='success', msg='') {
  const el = qs('#toastTop');
  el.className = `toast toast-${type==='success'?'toast-success':type==='error'?'toast-error':'toast-warning'}`;
  el.textContent = msg;
  requestAnimationFrame(()=>{ el.classList.add('show'); });
  setTimeout(()=>el.classList.remove('show'), 2800);
}
function showSystemToast(type='success', msg='') {
  const el = qs('#toastBottom');
  el.className = `toast toast-bottom ${type==='success'?'toast-success':type==='error'?'toast-error':'toast-warning'}`;
  el.textContent = msg;
  requestAnimationFrame(()=>{ el.classList.add('show'); });
  setTimeout(()=>el.classList.remove('show'), 3200);
}

/* ==========================
   Navbar & Theme
========================== */
(function initNavbar(){
  qs('#userAvatar').src = state.user.avatar;
  qs('#userName').textContent = state.user.name;

  const dd = qs('#userDropdown');
  qs('#userMenuBtn').addEventListener('click', e=>{
    e.stopPropagation();
    dd.classList.toggle('show');
  });
  document.addEventListener('click', ()=>dd.classList.remove('show'));

  qs('#openProfile').addEventListener('click', ()=>openProfile());
  qs('#openSettings').addEventListener('click', ()=>openSettings());
  qs('#logoutBtn').addEventListener('click', ()=>{ showToast('success','Logged out'); setTimeout(()=>location.reload(),600); });

  const savedTheme = localStorage.getItem('demipay_theme') || 'light';
  if(savedTheme==='dark'){ document.body.classList.add('dark'); qs('#themeIcon').textContent='‚òÄÔ∏è'; qs('#themeText').textContent='Light Mode'; }
  qs('#themeToggle').addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    const dark = document.body.classList.contains('dark');
    localStorage.setItem('demipay_theme', dark?'dark':'light');
    qs('#themeIcon').textContent = dark?'‚òÄÔ∏è':'üåô';
    qs('#themeText').textContent = dark?'Light Mode':'Dark Mode';
    showToast('success', dark?'üåô Dark mode enabled':'‚òÄÔ∏è Light mode restored');
  });
})();

/* ==========================
   Header / Balance
========================== */
function refreshHeader(){
  qs('#balanceAmount').textContent = fmtNGN(state.balance);
  qs('#walletAddress').textContent = `Wallet: ${state.user.wallet}`;
}
refreshHeader();
qs('#refreshBalance').addEventListener('click', ()=>{
  // mock: +‚Ç¶1,000
  state.balance += 1000;
  refreshHeader();
  showToast('success','Balance updated (+‚Ç¶1,000)');
});
qs('#addMoneyQuick').addEventListener('click', ()=>openAddWithdraw('add'));

/* ==========================
   Transactions
========================== */
function renderTx(){
  const root = qs('#txList'); root.innerHTML='';
  state.tx.slice(0,6).forEach(t=>{
    const isPos = t.amount>0;
    const el = document.createElement('div');
    el.className='tx';
    el.innerHTML = `
      <div class="tx-left">
        <div class="tx-ic">${isPos?'üì•':'üí∏'}</div>
        <div>
          <div style="font-weight:700">${t.kind} ${t.name}</div>
          <div class="muted" style="font-size:13px">${t.desc} ‚Ä¢ ${ago(t.ts)}</div>
        </div>
      </div>
      <div class="tx-right">
        <div class="${isPos?'positive':'negative'}">${isPos?'+':'‚àí'}${fmtNGN(Math.abs(t.amount))}</div>
        <div class="status">${t.status}</div>
      </div>
    `;
    root.appendChild(el);
  });
}
renderTx();
qs('#viewAllTx').addEventListener('click', ()=>showSystemToast('warning','Full transaction history is coming soon.'));

window.addEventListener('scroll', ()=>{
  if(scrollY>240) qs('#scrollTop').classList.add('show'); else qs('#scrollTop').classList.remove('show');
});
qs('#scrollTop').addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));

/* ==========================
   Reusable Modal
========================== */
const overlay = qs('#overlay');
qs('#modalClose').addEventListener('click', closeModal);
overlay.addEventListener('click', e=>{ if(e.target===overlay) closeModal(); });
function openModal(title, bodyHTML, footerHTML){
  qs('#modalTitle').textContent = title;
  qs('#modalBody').innerHTML = bodyHTML;
  qs('#modalFooter').innerHTML = footerHTML || `<button class="btn" onclick="closeModal()">Cancel</button>`;
  overlay.classList.add('show');
}
function closeModal(){ overlay.classList.remove('show'); }

/* ==========================
   Money Moves
========================== */
qs('#sendMoney').addEventListener('click', openSendMoney);
qs('#receiveMoney').addEventListener('click', openReceiveMoney);
qs('#addWithdraw').addEventListener('click', ()=>openAddWithdraw('add'));
qs('#bankTransfer').addEventListener('click', openBankTransfer);

function openSendMoney(){
  openModal('Send Money (‚Ç¶)', `
    <div class="row">
      <div class="col"><label>Recipient (Email / @Tag)</label><input id="sm_to" placeholder="e.g. jane@demipay.com or @janesmith"></div>
      <div class="col"><label>Amount (‚Ç¶)</label><input id="sm_amt" type="number" min="1" placeholder="1000"></div>
    </div>
    <div class="col"><label>Note</label><textarea id="sm_note" placeholder="What‚Äôs this for?"></textarea></div>
    <div class="col"><label>Fee (0.5%)</label><input id="sm_fee" disabled></div>
    <div class="col"><label>Total</label><input id="sm_total" disabled></div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="sm_send">Send</button>
  `);
  const amt = qs('#sm_amt'); const fee = qs('#sm_fee'); const total = qs('#sm_total');
  const calc = ()=>{
    const v = Number(amt.value||0);
    const f = +(v*0.005).toFixed(2);
    fee.value = fmtNGN(f);
    total.value = fmtNGN(v+f);
  };
  amt.addEventListener('input', calc); calc();
  qs('#sm_send').addEventListener('click', ()=>{
    const to = qs('#sm_to').value.trim(); const v=Number(amt.value||0);
    if(!to || v<=0) return showToast('error','Enter recipient and valid amount');
    if(v>state.balance) return showToast('error','Insufficient balance');
    state.balance -= v; state.tx.unshift({id:crypto.randomUUID(),kind:'Sent',name:to,desc:qs('#sm_note').value||'P2P transfer',amount:-v,status:'completed',ts:Date.now()});
    refreshHeader(); renderTx(); closeModal(); showToast('success',`Sent ${fmtNGN(v)} to ${to}`);
  });
}

function openReceiveMoney(){
  openModal('Receive Money (‚Ç¶)', `
    <div class="row">
      <div class="col"><label>Amount (‚Ç¶)</label><input id="rm_amt" type="number" min="1" placeholder="5000"></div>
      <div class="col"><label>Sender Name</label><input id="rm_from" placeholder="External Sender"></div>
    </div>
    <div class="col"><label>Note</label><textarea id="rm_note" placeholder="e.g. Refund"></textarea></div>
    <div class="col"><label>Scan this QR to pay</label>
      <div id="rm_qr" style="border:1px dashed rgba(148,163,184,.4);border-radius:12px;display:grid;place-items:center;height:160px;font-size:48px">‚ñ¶</div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="rm_receive">Mark as Received</button>
  `);
  qs('#rm_receive').addEventListener('click', ()=>{
    const v = Number(qs('#rm_amt').value||0); const from = qs('#rm_from').value||'External Sender';
    if(v<=0) return showToast('error','Enter a valid amount');
    state.balance += v; state.tx.unshift({id:crypto.randomUUID(),kind:'Received',name:from,desc:qs('#rm_note').value||'QR payment',amount:+v,status:'completed',ts:Date.now()});
    refreshHeader(); renderTx(); closeModal(); showToast('success',`Received ${fmtNGN(v)}`);
  });
}

function openAddWithdraw(mode='add'){
  openModal(`${mode==='add'?'Add':'Withdraw'} Money`, `
    <div class="row">
      <div class="col"><label>Method</label>
        <select id="aw_method">
          <option value="card">Card</option>
          <option value="bank">Bank</option>
        </select>
      </div>
      <div class="col"><label>Amount (‚Ç¶)</label><input id="aw_amt" type="number" min="1" placeholder="10000"></div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="aw_do">${mode==='add'?'Add':'Withdraw'}</button>
  `);
  qs('#aw_do').addEventListener('click', ()=>{
    const v = Number(qs('#aw_amt').value||0);
    if(v<=0) return showToast('error','Enter amount');
    if(mode==='add'){ state.balance+=v; showToast('success',`Added ${fmtNGN(v)}`);}
    else { if(v>state.balance) return showToast('error','Insufficient balance'); state.balance-=v; showToast('success',`Withdrew ${fmtNGN(v)}`);}
    state.tx.unshift({id:crypto.randomUUID(),kind:mode==='add'?'Received':'Sent',name:mode==='add'?'Card/Bank':'Withdrawal',desc:`Wallet ${mode}`,amount:mode==='add'?+v:-v,status:'completed',ts:Date.now()});
    refreshHeader(); renderTx(); closeModal();
  });
}

function openBankTransfer(){
  openModal('Bank Transfer (‚Ç¶)', `
    <div class="row">
      <div class="col"><label>Recipient Name</label><input id="bt_name" placeholder="Account holder name"></div>
      <div class="col"><label>Bank Name</label><input id="bt_bank" placeholder="e.g. GTBank"></div>
    </div>
    <div class="row">
      <div class="col"><label>Account Number</label><input id="bt_acct" placeholder="0123456789" maxlength="12"></div>
      <div class="col"><label>Amount (‚Ç¶)</label><input id="bt_amt" type="number" min="1" placeholder="15000"></div>
    </div>
    <div class="col"><label>Notes / Reference</label><input id="bt_note" placeholder="e.g. Rent, May 2026"></div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="bt_send">Send</button>
  `);
  qs('#bt_send').addEventListener('click', ()=>{
    const v = Number(qs('#bt_amt').value||0), name = qs('#bt_name').value.trim();
    if(!name || v<=0) return showToast('error','Name & amount required');
    if(v>state.balance) return showToast('error','Insufficient balance');
    state.balance -= v; state.tx.unshift({id:crypto.randomUUID(),kind:'Sent',name,desc:`Bank transfer ‚Ä¢ ${qs('#bt_bank').value||'Bank'}`,amount:-v,status:'completed',ts:Date.now()});
    refreshHeader(); renderTx(); closeModal(); showToast('success',`Transferred ${fmtNGN(v)} to ${name}`);
  });
}

/* ==========================
   Services
========================== */
qsa('.service').forEach(s=>s.addEventListener('click', ()=>{
  const k = s.dataset.service;
  if(k==='fx') return openFX();
  if(k==='savings') return openSavings();
  if(k==='bills') return openBills();
  if(k==='cards') return openCards();
  if(k==='payonline') return openCheckout();
  if(k==='shop') return openShop();
  if(k==='invest') return openInvest();
  if(k==='agent') return openAgent();
}));

function openFX(){
  openModal('Cross-Border Remittance', `
    <div class="row">
      <div class="col"><label>Recipient Name</label><input id="fx_name" placeholder="e.g. John Doe"></div>
      <div class="col"><label>Account Number</label><input id="fx_acct" placeholder="IBAN / Acct No."></div>
    </div>
    <div class="row">
      <div class="col"><label>Reason</label><input id="fx_reason" placeholder="Family support"></div>
      <div class="col"><label>Amount (‚Ç¶)</label><input id="fx_amt" type="number" min="1" placeholder="200000"></div>
    </div>
    <div class="col"><label>Notes</label><textarea id="fx_note" placeholder="Optional message"></textarea></div>
    <div class="card" style="margin-top:10px">
      <div class="muted">Preview</div>
      <div id="fx_preview" style="font-weight:700">‚Ç¶0 ‚Üí $0.00 @ ‚Ç¶${state.fxRate}/$</div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="fx_send">Send</button>
  `);
  const amt=qs('#fx_amt'); const prev=qs('#fx_preview');
  const upd=()=>{ const n=Number(amt.value||0); prev.textContent = `${fmtNGN(n)} ‚Üí ${fmtUSD((n/state.fxRate).toFixed(2))} @ ‚Ç¶${state.fxRate}/$`; };
  amt.addEventListener('input',upd); upd();
  qs('#fx_send').addEventListener('click', ()=>{
    const n=Number(amt.value||0); if(n<=0) return showToast('error','Enter amount');
    if(n>state.balance) return showToast('error','Insufficient balance');
    state.balance-=n; state.tx.unshift({id:crypto.randomUUID(),kind:'Sent',name:qs('#fx_name').value||'Recipient',desc:`Remittance (${qs('#fx_reason').value||'Transfer'})`,amount:-n,status:'completed',ts:Date.now()});
    refreshHeader(); renderTx(); closeModal(); showToast('success','Remittance sent');
  });
}

function openSavings(){
  openModal('Savings & Standing Orders', `
    <div class="row">
      <div class="col"><label>New Goal Name</label><input id="sv_name" placeholder="e.g. Car"></div>
      <div class="col"><label>Initial Amount (‚Ç¶)</label><input id="sv_amt" type="number" min="0" placeholder="5000"></div>
    </div>
    <div class="row">
      <div class="col"><label>Standing Order</label>
        <select id="sv_so"><option value="none">None</option><option>Daily</option><option>Weekly</option><option>Monthly</option></select>
      </div>
      <div class="col"><label>SO Amount (‚Ç¶)</label><input id="sv_so_amt" type="number" min="0" placeholder="10000"></div>
    </div>
    <div class="card">
      <canvas id="sv_chart" width="520" height="160"></canvas>
      <div id="sv_badges" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" id="sv_add">Add Goal</button>
  `);
  drawSavingsChart(); renderSavingsBadges();
  qs('#sv_add').addEventListener('click', ()=>{
    const name = qs('#sv_name').value.trim(); const v = Number(qs('#sv_amt').value||0);
    if(!name) return showToast('error','Enter goal name');
    state.savings.push({ id:crypto.randomUUID(), name, amount:v, color:'#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0') });
    drawSavingsChart(); renderSavingsBadges(); showToast('success','Goal added');
  });
}
function drawSavingsChart(){
  const c = qs('#sv_chart'); const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  const total = state.savings.reduce((a,b)=>a+b.amount,0) || 1;
  let start = -Math.PI/2;
  const cx = c.width/2, cy = c.height/2, r = 60;
  state.savings.forEach(s=>{
    const ang = 2*Math.PI*(s.amount/total);
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,start+ang); ctx.closePath();
    ctx.fillStyle = s.color; ctx.fill();
    start += ang;
  });
  // legend
  let x=20,y=20;
  state.savings.forEach(s=>{
    ctx.fillStyle=s.color; ctx.fillRect(x,y,12,12);
    ctx.fillStyle='currentColor'; ctx.fillText(`${s.name}: ${fmtNGN(s.amount)}`, x+18, y+11);
    y+=18;
  });
}
function renderSavingsBadges(){
  const root = qs('#sv_badges'); root.innerHTML='';
  state.savings.forEach(s=>{
    const b = document.createElement('div');
    b.style = `border:1px solid rgba(148,163,184,.3);padding:6px 10px;border-radius:999px;display:flex;gap:6px;align-items:center`;
    b.innerHTML = `<span style="width:10px;height:10px;border-radius:999px;background:${s.color};display:inline-block"></span> ${s.name} ‚Ä¢ <b>${fmtNGN(s.amount)}</b>`;
    root.appendChild(b);
  });
}

function openBills(){
  openModal('Pay Bills & Top-Up', `
    <div class="col">
      <label>Category</label>
      <select id="bl_cat">
        <option value="electricity">Electricity</option>
        <option value="water">Water</option>
        <option value="dstv">DSTV</option>
        <option value="airtime">Airtime</option>
      </select>
    </div>
    <div id="bl_dynamic"></div>
    <div class="col">
      <label>Make it recurring?</label>
      <select id="bl_rec"><option>None</option><option>Weekly</option><option>Monthly</option></select>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="bl_pay">Pay</button>
  `);
  const dyn = qs('#bl_dynamic');
  function renderForm(){
    const v = qs('#bl_cat').value; dyn.innerHTML='';
    if(v==='airtime'){
      dyn.innerHTML = `
        <div class="row">
          <div class="col"><label>Provider</label>
            <select id="bl_air"><option>MTN</option><option>Glo</option><option>Airtel</option><option>9mobile</option></select>
          </div>
          <div class="col"><label>Phone Number</label><input id="bl_phone" placeholder="080..."></div>
        </div>
        <div class="col"><label>Amount (‚Ç¶)</label><input id="bl_amt" type="number" min="100" placeholder="1000"></div>
      `;
    } else if(v==='electricity' || v==='water'){
      dyn.innerHTML = `
        <div class="row">
          <div class="col"><label>Provider</label><input id="bl_prov" placeholder="e.g. Ikeja Electric"></div>
          <div class="col"><label>Account/Meter Number</label><input id="bl_acc" placeholder="Meter/Acct"></div>
        </div>
        <div class="row">
          <div class="col"><label>Plan</label>
            <select id="bl_plan"><option>‚Ç¶500</option><option>‚Ç¶1,000</option><option>‚Ç¶2,000</option><option>‚Ç¶5,000</option></select>
          </div>
          <div class="col"><label>Amount (‚Ç¶)</label><input id="bl_amt" type="number" min="500" placeholder="2000"></div>
        </div>
      `;
    } else { // DSTV
      dyn.innerHTML = `
        <div class="row">
          <div class="col"><label>Account Number</label><input id="bl_acc" placeholder="Smartcard No."></div>
          <div class="col"><label>Plan</label>
            <select id="bl_plan"><option>Compact</option><option>Compact Plus</option><option>Premium</option></select>
          </div>
        </div>
        <div class="col"><label>Amount (‚Ç¶)</label><input id="bl_amt" type="number" min="1000" placeholder="10000"></div>
      `;
    }
  }
  qs('#bl_cat').addEventListener('change', renderForm); renderForm();

  qs('#bl_pay').addEventListener('click', ()=>{
    const amount = Number(qs('#bl_amt')?.value||0);
    if(amount<=0) return showToast('error','Enter amount');
    if(amount>state.balance) return showToast('error','Insufficient balance');
    state.balance -= amount;
    state.tx.unshift({id:crypto.randomUUID(),kind:'Sent',name:'Bills/TopUp',desc:qs('#bl_cat').value,amount:-amount,status:'completed',ts:Date.now()});
    refreshHeader(); renderTx(); closeModal(); showToast('success','Bill paid');
  });
}

function openCards(){
  openModal('Virtual & Linked Cards', `
    <div class="grid" style="grid-template-columns:repeat(2,1fr)">
      ${state.cards.map(c=>cardHTML(c)).join('')}
    </div>
    <div style="height:10px"></div>
    <button class="btn" id="addCardBtn">Add / Link Card</button>
    <div id="addCardForm" style="display:none;margin-top:10px">
      <div class="row">
        <div class="col"><label>Cardholder Name</label><input id="cc_name" placeholder="Demi Olawoye"></div>
        <div class="col"><label>Card Number</label><input id="cc_no" placeholder="4111 1111 1111 1111" maxlength="19"></div>
      </div>
      <div class="row">
        <div class="col"><label>Expiry</label><input id="cc_exp" placeholder="MM/YY" maxlength="5"></div>
        <div class="col"><label>CVV</label><input id="cc_cvv" placeholder="123" maxlength="4"></div>
      </div>
      <button class="btn btn-primary" id="cc_save">Link Card</button>
    </div>
  `, `<button class="btn" onclick="closeModal()">Close</button>`);
  qs('#addCardBtn').addEventListener('click', ()=>{
    qs('#addCardForm').style.display = qs('#addCardForm').style.display==='none'?'block':'none';
  });
  qs('#cc_save').addEventListener('click', ()=>{
    const last4 = (qs('#cc_no').value||'0000').replace(/\s+/g,'').slice(-4)||'0000';
    state.cards.push({id:crypto.randomUUID(),brand:'Linked Card',last4, type:'linked',bank:'Linked',contactless:true});
    showToast('success','Card linked');
    closeModal(); openCards();
  });
  qsa('[data-card-id]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      state.defaultCard = btn.dataset.cardId;
      showToast('success','Default card set');
      closeModal(); openCards();
    });
  });
}
function cardHTML(c){
  const isDefault = state.defaultCard===c.id;
  return `
    <div class="card" style="position:relative;overflow:hidden">
      <div style="position:absolute;inset:0;background:linear-gradient(135deg, rgba(45,212,191,.2), rgba(59,130,246,.15));pointer-events:none"></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-weight:800">${c.brand}</div><div class="muted">${c.bank} ‚Ä¢ **** ${c.last4}</div></div>
        <div>${c.contactless?'üì∂':''}</div>
      </div>
      <div style="margin-top:8px">
        ${isDefault?'<span class="badge">Default</span>':''}
        <button class="btn" data-card-id="${c.id}" style="float:right">${isDefault?'Selected':'Set Default'}</button>
      </div>
    </div>`;
}

function openCheckout(){
  openModal('Pay Online ‚Äî Checkout', `
    <div class="row">
      <div class="col"><label>Item</label><input id="po_item" value="Concert Ticket"></div>
      <div class="col"><label>Price (USD)</label><input id="po_usd" type="number" step="0.01" value="25"></div>
    </div>
    <div class="row">
      <div class="col"><label>Pay In</label>
        <select id="po_ccy"><option value="ngn">‚Ç¶ NGN</option><option value="usd">$ USD</option></select>
      </div>
      <div class="col"><label>Converted (‚Ç¶)</label><input id="po_ngn" disabled></div>
    </div>
    <div class="col"><label>Card</label>
      <select id="po_card">
        ${state.cards.map(c=>`<option value="${c.id}" ${c.id===state.defaultCard?'selected':''}>${c.brand} ‚Ä¢ ****${c.last4}</option>`).join('')}
      </select>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="po_pay">Pay</button>
  `);
  const upd=()=>{
    const usd=Number(qs('#po_usd').value||0); qs('#po_ngn').value = fmtNGN(usd*state.fxRate);
  }; upd(); qs('#po_usd').addEventListener('input',upd);
  qs('#po_pay').addEventListener('click', ()=>{
    const usd = Number(qs('#po_usd').value||0); if(usd<=0) return showToast('error','Enter price');
    const payIn = qs('#po_ccy').value;
    const debit = payIn==='usd' ? (usd*state.fxRate) : (usd*state.fxRate); // both reduce NGN wallet in this mock
    if(debit>state.balance) return showToast('error','Insufficient balance');
    state.balance -= debit;
    state.tx.unshift({id:crypto.randomUUID(),kind:'Sent',name:'Online Checkout',desc:`${qs('#po_item').value} (${payIn.toUpperCase()})`,amount:-debit,status:'completed',ts:Date.now()});
    refreshHeader(); renderTx(); closeModal(); showToast('success','Payment complete');
  });
}

function openShop(){
  openModal('Shop on the Fly', `
    <div class="grid" style="grid-template-columns:repeat(3,1fr)">
      ${[
        {cat:'Taxi', items:['Uber','Bolt','InDrive']},
        {cat:'Entertainment', items:['Filmhouse','O2 Arena','Ticketmaster']},
        {cat:'Shops', items:['Jiji','AliExpress','ASOS']},
        {cat:'Food', items:['Domino‚Äôs','KFC','Chicken Republic']}
      ].map(g=>`
        <div class="card">
          <div style="font-weight:800;margin-bottom:6px">${g.cat}</div>
          ${g.items.map(i=>`<a href="#" onclick="showSystemToast('success','Opening ${i}‚Ä¶');return false;" style="display:block;padding:6px 0;color:var(--brand2)">${i} ‚Üó</a>`).join('')}
        </div>
      `).join('')}
    </div>
  `, `<button class="btn" onclick="closeModal()">Close</button>`);
}

function openInvest(){
  openModal('Investments & Stocks', `
    <div class="row">
      <div class="col"><label>View</label>
        <select id="inv_tab"><option value="stocks">Stocks</option><option value="invest">Investments</option></select>
      </div>
      <div class="col"><label>FX</label><input disabled value="‚Ç¶${state.fxRate} per $"></div>
    </div>
    <div id="inv_list" style="margin-top:10px"></div>
    <div class="card" style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:6px">My Stocks</div>
      <div id="inv_mine" class="muted">No holdings yet.</div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Close</button>
  `);
  const list = qs('#inv_list');
  const stocks = [
    {sym:'AAPL', name:'Apple', px:230.12},
    {sym:'MSFT', name:'Microsoft', px:407.33},
    {sym:'NVDA', name:'NVIDIA', px:120.15},
  ];
  const invests = [
    {sym:'TBILL', name:'Nigeria T-Bill (90d)', px:100.00},
    {sym:'AGRI', name:'Agri Fund', px:12.45},
  ];
  function render(which='stocks'){
    const data = which==='stocks'?stocks:invests;
    list.innerHTML = data.map(x=>`
      <div class="tx" style="align-items:center">
        <div class="tx-left">
          <div class="tx-ic">üìà</div>
          <div><div style="font-weight:700">${x.name} (${x.sym})</div><div class="muted">Market: USD</div></div>
        </div>
        <div class="tx-right">
          <div style="font-weight:800">${fmtUSD(x.px)}</div>
          <button class="btn btn-primary" onclick="addToCart('${x.sym}','${x.name}',${x.px})">Buy</button>
        </div>
      </div>
    `).join('');
  }
  qs('#inv_tab').addEventListener('change', e=>render(e.target.value));
  render('stocks');
}
function addToCart(sym,name,px){
  // checkout with currency toggle
  openModal(`Buy ${name} (${sym})`, `
    <div class="row">
      <div class="col"><label>Units</label><input id="iv_qty" type="number" min="1" value="1"></div>
      <div class="col"><label>Price (USD)</label><input disabled value="${fmtUSD(px)}"></div>
    </div>
    <div class="row">
      <div class="col"><label>Pay In</label><select id="iv_ccy"><option value="usd">$ USD</option><option value="ngn">‚Ç¶ NGN</option></select></div>
      <div class="col"><label>Estimated (‚Ç¶)</label><input id="iv_ngn" disabled></div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="iv_buy">Buy Now</button>
  `);
  const qty=qs('#iv_qty'), ngn=qs('#iv_ngn');
  const upd=()=>{ ngn.value = fmtNGN((Number(qty.value||0)*px*state.fxRate)); }; upd(); qty.addEventListener('input',upd);
  qs('#iv_buy').addEventListener('click', ()=>{
    const q=Number(qty.value||0); if(q<=0) return showToast('error','Enter units');
    const pay = q*px*state.fxRate; if(pay>state.balance) return showToast('error','Insufficient balance');
    state.balance -= pay;
    state.tx.unshift({id:crypto.randomUUID(),kind:'Sent',name:`Buy ${sym}`,desc:`${name} ‚Ä¢ ${q} unit(s)`,amount:-pay,status:'completed',ts:Date.now()});
    refreshHeader(); renderTx(); closeModal(); showToast('success','Purchase complete (paid in ‚Ç¶).');
  });
}

function openAgent(){
  openModal('Become an Agent', `
    <div class="row">
      <div class="col"><label>Full Name</label><input id="ag_name" placeholder="John Doe" required></div>
      <div class="col"><label>Business Name</label><input id="ag_biz" placeholder="Doe Ventures Ltd"></div>
    </div>
    <div class="row">
      <div class="col"><label>NIN (required)</label><input id="ag_nin" placeholder="11-digit NIN" maxlength="11" required></div>
      <div class="col"><label>Photo ID ‚Äî Capture</label>
        <div style="display:flex;gap:8px">
          <button class="btn" id="ag_cam">Open Camera</button>
          <input type="file" id="ag_file" accept="image/*" capture="environment" style="flex:1">
        </div>
      </div>
    </div>
    <div class="card" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <video id="ag_video" autoplay playsinline style="width:100%;border-radius:12px;display:none"></video>
      <canvas id="ag_canvas" width="320" height="240" style="width:100%;border-radius:12px;background:rgba(148,163,184,.12)"></canvas>
      <button class="btn" id="ag_snap" style="grid-column:span 2">üì∏ Take Photo</button>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" id="ag_submit">Submit Application</button>
  `);

  let stream=null;
  qs('#ag_cam').addEventListener('click', async ()=>{
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:true});
      const v = qs('#ag_video'); v.srcObject = stream; v.style.display='block';
      showSystemToast('success','Camera ready ‚Äî take a photo');
    }catch(e){ showToast('error','Camera access denied'); }
  });
  qs('#ag_snap').addEventListener('click', ()=>{
    const v=qs('#ag_video'); const c=qs('#ag_canvas'); const ctx=c.getContext('2d');
    if(!v.srcObject) return showToast('warning','Open camera first');
    ctx.drawImage(v,0,0,c.width,c.height);
    showToast('success','Photo captured');
  });
  qs('#ag_file').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const img=new Image(); img.onload=()=>{ const c=qs('#ag_canvas'); const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height); showToast('success','Photo loaded'); };
    img.src = URL.createObjectURL(f);
  });
  qs('#ag_submit').addEventListener('click', ()=>{
    const nin = qs('#ag_nin').value.trim();
    if(nin.length!==11) return showToast('error','NIN must be 11 digits');
    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    closeModal(); showToast('success','Agent application submitted');
  });
}

/* ==========================
   Profile / Settings
========================== */
function openProfile(){
  openModal('Profile', `
    <div class="row">
      <div class="col"><label>Full Name</label><input id="pr_name" value="${state.user.name}"></div>
      <div class="col"><label>Wallet</label><input disabled value="${state.user.wallet}"></div>
    </div>
    <div class="col"><label>Avatar URL</label><input id="pr_avatar" value="${state.user.avatar}"></div>
  `, `
    <button class="btn" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" id="pr_save">Save</button>
  `);
  qs('#pr_save').addEventListener('click', ()=>{
    state.user.name = qs('#pr_name').value || state.user.name;
    state.user.avatar = qs('#pr_avatar').value || state.user.avatar;
    qs('#userName').textContent = state.user.name;
    qs('#userAvatar').src = state.user.avatar;
    closeModal(); showToast('success','Profile updated');
  });
}
function openSettings(){
  openModal('Settings', `
    <div class="col"><label>Theme</label>
      <select id="st_theme"><option value="light">Light</option><option value="dark">Dark</option></select>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" id="st_save">Save</button>
  `);
  qs('#st_theme').value = document.body.classList.contains('dark')?'dark':'light';
  qs('#st_save').addEventListener('click', ()=>{
    const v = qs('#st_theme').value; if(v==='dark') document.body.classList.add('dark'); else document.body.classList.remove('dark');
    localStorage.setItem('demipay_theme', v);
    closeModal(); showToast('success','Settings saved');
  });
}

/* ==========================
   Safety: global error -> toast
========================== */
window.addEventListener('error', e=>{
  console.error(e.error||e.message);
  showSystemToast('error','An error occurred in the page script.');
});
</script>
</body>
</html>
